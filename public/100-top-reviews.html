<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reviews</title>
  <link href="//cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="//cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/fuse.js@6.4.6"></script>
  <script src="//cdn.jsdelivr.net/npm/vue@2"></script>
</head>
<body class="p-2">
  <div id="app">
    <div class="flex justify-between items-center">
      <div>
        <h1 class="text-2xl font-bold">Reviews</h1>
        <p class="mb-4">100 reviews from each</p>
      </div>
      <div>
        <ul class="flex items-center space-x-1">
          <li v-for="tagName in tagOptions">
            <button
              class="rounded px-1.5 py-1 flex items-center space-x-1 border-2 w-full hover:bg-gray-100"
              :class="{
                'border-blue-300': tagFilter === tagName,
                'border-gray-200': tagFilter !== tagName,
              }"
              @click="filterTag(tagName)"
            >
              <span class="w-3 h-3 flex" :class="colorForTag(tagName)"></span>
              <span>{{ tagName }}</span>
            </button>
          </li>
        </ul>
      </div>
      <div class="flex flex-col">
        <span class="text-sm font-bold">
          Search Reviews
        </span>
        <input :disabled="!!tagFilter" type="text" v-model="searchQuery" placeholder="Sapphic" class="mb-4 p-2 border border-gray-300 rounded" />
      </div>
    </div>
    <table class="table-auto border-collapse border border-gray-400 w-full" @mouseup="handleSelection">
      <thead>
        <tr>
          <th class="border border-gray-300 px-4 py-2 align-top hover:bg-gray-300">
            <button class="w-full" @click="sortBy('id')">
              <span>ID</span>
              <template v-if="currentSort === 'id'">
                <span v-if="currentSortDir === 'asc'">▲</span>
                <span v-else>▼</span>
              </template>
            </button>
          </th>
          <th class="border border-gray-300 px-4 py-2 align-top hover:bg-gray-300">
            <button class="w-full flex space-x-1.5" @click="sortBy('book')">
              <span>Book</span>
              <template v-if="currentSort === 'book'">
                <span v-if="currentSortDir === 'asc'">▲</span>
                <span v-else>▼</span>
              </template>
            </button>
          </th>
          <th class="border border-gray-300 px-4 py-2 align-top hover:bg-gray-300">
            <button class="w-full flex space-x-1.5" @click="sortBy('rating')">
              <span>Rating</span>
              <template v-if="currentSort === 'rating'">
                <span v-if="currentSortDir === 'asc'">▲</span>
                <span v-else>▼</span>
              </template>
            </button>
          </th>
          <th class="border border-gray-300 px-4 py-2 align-top hover:bg-gray-300">
            <button class="w-full flex space-x-1.5" @click="sortBy('date')">
              <span>Date</span>
              <template v-if="currentSort === 'date'">
                <span v-if="currentSortDir === 'asc'">▲</span>
                <span v-else>▼</span>
              </template>
            </button>
          </th>
          <th class="border border-gray-300 px-4 py-2 align-top hover:bg-gray-300">
            <button class="w-full flex space-x-1.5 items-baseline" @click="sortBy('review')">
              <span>Review</span>
              <span class="text-gray-500 text-sm" v-if="tagFilter">(Filter: "{{tagFilter}}")</span>
              <template v-if="currentSort === 'review'">
                <span v-if="currentSortDir === 'asc'">▲</span>
                <span v-else>▼</span>
              </template>
            </button>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr
          v-for="(review, index) in sortedTopHits"
          :key="index"
          :data-id="review.id"
        >
          <td
            v-for="(value, key) in review"
            class="border border-gray-300 px-4 py-2 align-top"
            v-html="highlightTaggings(key, review)"
          ></td>
        </tr>
      </tbody>
    </table>
    <ul
      v-if="taggingReviewId"
      class="rounded border border-gray-300 space-y-px bg-gray-300 overflow-hidden"
      :style="{
        position: 'absolute',
        top: selectionPosition.top + 5 + 'px',
        left: selectionPosition.left + 'px'
      }"
    >
        <li v-for="tagName in tagOptions" class="overflow-hidden">
          <button class="px-2 py-1.5 flex items-center space-x-1 w-full bg-gray-200 hover:bg-gray-100" @click="handleTag(tagName)">
            <span class="w-3 h-3 flex" :class="colorForTag(tagName)"></span>
            <span>{{ tagName }}</span>
          </button>
        </li>
        <li>
          <button class="px-2 py-1.5 bg-gray-200 w-full hover:bg-gray-100"  @click="handleTag(ADD_TAG)">
            + Add New Tag
          </button>
        </li>
    </ul>
    <ul
      v-if="editTagging"
      class="rounded bg-gray-100 border border-gray-300 space-y-px bg-gray-300 overflow-hidden"
      :style="{
        position: 'absolute',
        top: selectionPosition.top + 5 + 'px',
        left: selectionPosition.left + 'px'
      }"
    >
      <li>
        <button class="px-2 py-1.5 text-sm bg-gray-200 hover:bg-gray-100"  @click="handleRemoveTagging">
          Remove Highlight
        </button>
      </li>
    </ul>
  </div>

  <script>
    const DEBUG = "Who knew a fantasy that combines political scheming, colonialism, war, and a queer accountant who uses financial policies to achieve her aims would be so compelling? The author is brilliant."
    const ADD_TAG = "add_tag"
    const COLORS = [
      "bg-red-200",
      "bg-yellow-200",
      "bg-green-200",
      "bg-blue-200",
      "bg-purple-200",
      "bg-pink-200",
      "bg-lime-200",
      "bg-teal-200",
      "bg-orange-200",
      "bg-cyan-200"
    ]

    function makeHighlightClickHandler(event, tagName, reviewId, tagIdx) {
      event.stopPropagation();
      window.dispatchEvent(new CustomEvent('highlight-click', {
        detail: {
          target: event.target,
          tagName: tagName,
          reviewId: reviewId,
          tagIdx: tagIdx
        }
      }));
    }

    window.onload = () => {
      new Vue({
        el: '#app',
        data: {
          reviews: [],

          currentSort: '',
          currentSortDir: 'asc',

          searchQuery: '',
          fuse: null,
          options: {
            keys: ['review'],
            threshold: 0.3
          },

          selectionPosition: { top: 0, left: 0 },
          currentRange: null,
          selectedText: null,
          taggingReviewId: null,

          tags: [],
          ADD_TAG,

          editTagging: null,
          tagFilter: null,
        },
        mounted() {
          this.fuse = new Fuse(this.reviews, this.options)
          this.hydrateTags()
          window.addEventListener('keydown', this.handleKeydown)
          window.addEventListener('highlight-click', this.handleHighlightClick)
        },
        beforeDestroy() {
          window.removeEventListener('keydown', this.handleKeydown)
        },
        created() {
          fetch('./reviews.json')
            .then(response => response.json())
            .then(data => {
              this.reviews = data
            })
            .catch(error => console.error('Error loading JSON:', error))
        },
        computed: {
          filteredReviews() {
            if (this.searchQuery.trim() === '') {
              const taggingReviewIds = new Set(_.keys(this.tags?.[this.tagFilter]))
              if (taggingReviewIds.size) {
                return _.filter(this.reviews, r => taggingReviewIds.has(r.id))
              } else {
                return this.reviews
              }
            }
            return this.fuse.search(this.searchQuery).map(result => result.item)
          },
          sortedTopHits() {
            return this.filteredReviews.slice().sort((a, b) => {
              let modifier = this.currentSortDir === 'asc' ? 1 : -1
              if (a[this.currentSort] < b[this.currentSort]) return -1 * modifier
              if (a[this.currentSort] > b[this.currentSort]) return 1 * modifier
              return 0
            })
          },

          tagOptions() {
            return _.keys(this.tags)
          },
        },
        watch: {
          tags: 'dehydrateTags',
        },
        methods: {
          sortBy(column) {
            if (this.currentSort === column) {
              this.currentSortDir = this.currentSortDir === 'asc' ? 'desc' : 'asc'
            } else {
              this.currentSort = column
              this.currentSortDir = 'asc'
            }
          },
          handleSelection() {
            const selection = window.getSelection()
            if (selection.toString().length > 5) {
              this.editTagging = null
              const range = selection.getRangeAt(0)


              // Find the closest tr element and get its data-id attribute
              const trElement = range.startContainer.parentElement.closest('tr')
              if (!trElement) return console.error('Cannot find tr')
              const reviewId = trElement.getAttribute('data-id')
              if (!reviewId) return console.error('Cannot find reviewId on tr')
              this.taggingReviewId = reviewId

              // Enter tagging mode
              const rect = range.getBoundingClientRect()
              this.selectionPosition = { top: rect.bottom + window.scrollY, left: rect.left + window.scrollX }
              this.selectedText = selection.toString()
              this.currentRange = range
            }
          },
          handleTag(tag) {
            if (tag === ADD_TAG) {
              tag = prompt('Label for your new tag?')
            }
            if (tag) {
              if (!this.taggingReviewId) return console.error('No taggingReviewId')
              if (!this.selectedText) return console.error('No selectedText')
              if (!this.currentRange) return console.error('No currentRange')

              // Make a copy
              const tagsCopy = {...this.tags}

              // Ensure tag is initialized
              tagsCopy[tag] = tagsCopy[tag] || {}

              // Clone the contents of the current range
              const clonedContents = this.currentRange.cloneContents();
              const div = document.createElement('div');
              div.appendChild(clonedContents);

              // Add new tagging
              const newTagging = {
                text: div.textContent, // Store text content
                html: div.innerHTML, // Store HTML content
                range: this.currentRange,
              };
              tagsCopy[tag][this.taggingReviewId] = [
                // Ensure review is initialized
                ...(tagsCopy[tag][this.taggingReviewId] || []),
                newTagging,
              ]

              // Write to tags
              this.tags = tagsCopy

              // Clean up
              this.selectedText = null
              this.currentRange = null
              this.taggingReviewId = null
            }
          },
          hydrateTags() {
            const tagsJSON = localStorage.getItem('tags') || '{}'
            this.tags = JSON.parse(tagsJSON)
          },
          dehydrateTags(newTags, oldTags) {
            if (!newTags || !oldTags) return // hydrating

            const tagsJSON = JSON.stringify(newTags)
            localStorage.setItem('tags', tagsJSON)
          },
          handleKeydown(event) {
            if (event.key === 'Escape') {
              this.taggingReviewId = null
            }
          },

          colorForTag(tagName) {
            const tagNames = Object.keys(this.tags)
            const i = tagNames.indexOf(tagName)
            return COLORS[i % COLORS.length]
          },

          escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // $& means the whole matched string
          },

          highlightTaggings(field, review) {
            let text = review[field]

            // Only highlight strings
            if (!_.isString(text)) return text

            _.each(this.tags, (tag, tagName) => {
              const color = this.colorForTag(tagName)
              const taggings = tag[review.id] || []
              taggings.forEach((tagging, tagIdx) => {
                const escapedText = this.escapeRegExp(tagging.html || tagging.text);
                const regex = new RegExp(`(${escapedText})`, 'gi');
                text = text.replace(regex, `<span onclick="makeHighlightClickHandler(event, '${tagName}', '${review.id}', '${tagIdx}')" class="${color}">$1</span>`);
              })
            });

            return text
          },

          handleHighlightClick(event) {
            const { target, ...editTagging} = event.detail || {}
            if (target) {
              this.taggingReviewId = null
              this.editTagging = editTagging
              const rect = target.getBoundingClientRect()
              this.selectionPosition = { top: rect.bottom + window.scrollY, left: rect.left + window.scrollX }
            }
          },

          handleRemoveTagging() {
            if (!this.editTagging) {
              return console.error('No tagging being edited')
            } else {
              const { tagName, reviewId, tagIdx } = this.editTagging
              const copy = _.cloneDeep(this.tags);
              _.pullAt(copy[tagName][reviewId], tagIdx);
              this.tags = copy
              this.editTagging = null
            }
          },

          filterTag(newTagFilter) {
            // Toggle
            if (this.tagFilter === newTagFilter) {
              this.tagFilter = null
            } else {
              this.tagFilter = newTagFilter
            }
          }
        }
      })
    }
  </script>
</body>
</html>
